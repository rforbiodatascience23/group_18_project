---
title: "05_analysis_1.qmd"
format: html
editor: visual
---

# Analysis 1

## Load clean data from data folder

```{r warning=FALSE}

analysis_1 <- read_tsv(
  file = "~/group_18_project/data/03_dat_aug1.tsv",
  show_col_types = FALSE)

analysis_2 <- read_tsv(
  file = "~/group_18_project/data/02_dat_clean2.tsv",
  show_col_types = FALSE)
```

## Plot number 1

Frequency of patients affected with Radiation-Induced Hemorrhagic Cystitis by type of radiation treatment received

```{r}

plot1 <- analysis_2 |> 
  count(treatment, hc_incidence) |>
  group_by(treatment) |>
  mutate(freq = n / sum(n)) |>
  ggplot(aes(x = treatment, 
           y = freq,
           fill = hc_incidence)) +  
  geom_col(position = position_dodge(
    preserve = "single"),
    colour = "black",
    alpha = 0.5) +
  geom_hline(yintercept = 0) +
  labs(x = "Treatment Received",    
       y = "Proportion",              
       fill = "Radiation-Induced Hemorrhagic Cystitis"     
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "top",
        panel.grid.major.x = element_blank(),
        axis.text.x = element_text(angle = 45,
                                   hjust = 1,
                                   vjust = 1.1))

ggsave(filename = "key_plot_1.png", 
      plot = plot1, 
      path = "~/group_18_project/results",
      width = 8, 
      height = 5, 
      dpi = 300)
```

## Plot number 2

Linear Regression Analysis of Body Mass Index (BMI) in relation to radiation dose.

```{r}
# Read data from the TSV file
data <- read.delim('~/group_18_project/data/02_dat_clean1.tsv')

#Create the plot
plot2 <- analysis_1 |> 
  na.omit(analysis_1) |> 
  ggplot(aes(x=radiation_dosage, y=BMI)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  theme_minimal(base_size = 16) +
  labs(x = "Radiation Dose",    
       y = "BMI",              
       title = "Linear Regression between BMI and radiation dose"     
  ) +
  theme(plot.title = element_text(hjust = 0.5, size = 16))  

# Perform linear regression
model <- lm(radiation_dosage ~ BMI, data = analysis_1)

# Print regression summary
summary(model)

#Print plot
print(plot2)

# Save plot to folder called "results"
ggsave(filename = "key_plot_2.png", 
      plot = plot2, 
      path = "~/group_18_project/results",
      width = 8, 
      height = 5, 
      dpi = 300)
```

## Plot number 3

Analysis of Patient Dose Percentages: Distinguishing Low, Medium, and High Levels across various radiation types.

```{r}
# Define dose categories based on paper
low_dose_threshold <- 70
high_dose_threshold <- 85

# Categorize doses using mutate
analysis_1 <- mutate(analysis_1, 
                      dose_category = cut(radiation_dosage, 
                                          breaks = c(-Inf,low_dose_threshold, high_dose_threshold, Inf),
                                          labels = c('Low Dose', 'Medium Dose', 'High Dose')))

# Calculate percentages for each type of radiation using summarise
result <- analysis_1 |> 
  group_by(radiation_type, dose_category) |> 
  summarise(Percentage = n() / nrow(analysis_1) * 100) |> 
  ungroup()  # Ungroup the data

# Create a grouped bar plot
plot3 <- result |> 
  ggplot(aes(x = radiation_type, y = Percentage, fill = dose_category)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7) +
  labs(title = "Percentage of Radiation Dosage in Each Dose Category by Radiation Type",
       x = "Radiation Type",
       y = "Percentage") +
  scale_fill_manual(values = c('Low Dose' = 'lightblue', 'Medium Dose' = 'lightgreen', 'High Dose' = 'lightcoral', 'NAs'='darkgrey')) +
  theme_classic(base_size = 8) + 
  theme(axis.text.x = element_text(angle = 65, hjust = 1, vjust = 1))

#Print plot
print(plot3)

# Save plot to the "results" folder
ggsave(filename = "key_plot_3.png", 
      plot = plot3, 
      path = "~/group_18_project/results",
      width = 8, 
      height = 5, 
      dpi = 300)
```

## Plot number 4

Comparison of the average time passed since the completion of radiation treatment and the first incident of HC

```{r}
plot2_data <- analysis_1 |>
  select(radiation_type, radiation_completion_to_first_hc) |>
  mutate(TimePassed = as.numeric(radiation_completion_to_first_hc)) |>
  filter(!is.na(TimePassed)) |> 
  filter(!is.na(radiation_type)) 

result <- plot2_data |>
  group_by(radiation_type) |>
  summarize(
    AvgTimePassed = mean(TimePassed),
    MedianTimePassed = median(TimePassed),
    TotalObservations = n())

plot4 <- 
  ggplot(result, aes(x = radiation_type, y = AvgTimePassed, fill = radiation_type)) +
  geom_bar(stat = "identity", position = "dodge", color = "black") +
  labs(expression(title = "Comparison of Average Time Since Radiation and Time to HC"),
       x = "Type of Radiation",
       y = "Average Time Since Radiation (months)") +
  theme_minimal()
  

print(plot4)

# Save plot to the "results" folder
ggsave(filename = "key_plot_4.png", 
      plot = plot4, 
      path = "~/group_18_project/results",
      width = 8, 
      height = 5, 
      dpi = 300)
```

Wasn't this calculated previously?? please check plot 3

```{r}

# Calculate the percentage of patients who received low, medium, and high doses for each radiation type
percentage_df <- analysis_1 |> 
  group_by(radiation_type)  |> 
  summarize(
    Low = sum(radiation_dosage < 50) / n() * 100,
    Medium = sum(radiation_dosage >= 50 & radiation_dosage < 70) / n() * 100,
    High = sum(radiation_dosage >= 70) / n() * 100
  )

# Print the resulting data frame
print(percentage_df)

```

## Plot number 5

please describe the plot here

```{r}
# Melt the data frame to long format for easier plotting
melted_df <- tidyr::gather(percentage_df, key = "DoseCategory", value = "Percentage", -radiation_type)

# Create a stacked bar plot
ggplot(melted_df, aes(x = radiation_type, y = Percentage, fill = DoseCategory)) +
  geom_bar(stat = "identity", position = "stack", color = "black") +
  labs(
    title = "Percentage of Patients in Low, Medium, and High Dose Categories",
    x = "Radiation Type",
    y = "Percentage"
  ) +
  scale_fill_manual(values = c("Low" = "skyblue", "Medium" = "lightcoral", "High" = "gold")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r}
library(ggplot2)

# Melt the data frame to long format for easier plotting
melted_df <- tidyr::gather(percentage_df, key = "DoseCategory", value = "Percentage", -radiation_type)

# Create a larger stacked bar plot with extended y-axis range
plot5 <- ggplot(melted_df, aes(x = radiation_type, y = Percentage, fill = DoseCategory)) +
  geom_bar(stat = "identity", position = "stack", color = "black") +
  labs(
    title = "Percentage of Patients in Low, Medium, and High Dose Categories",
    x = "Radiation Type",
    y = "Percentage"
  ) +
  scale_fill_manual(values = c("Low" = "skyblue", "Medium" = "lightcoral", "High" = "gold")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(axis.title.y = element_text(size = 12)) +  # Adjust y-axis title size
  theme(axis.text.y = element_text(size = 10)) +   # Adjust y-axis text size
  coord_cartesian(ylim = c(0, 150))  # Set y-axis range

# Save plot to the "results" folder
ggsave(filename = "key_plot_5.png", 
      plot = plot5, 
      path = "~/group_18_project/results",
      width = 8, 
      height = 5, 
      dpi = 300)

```

Plot number 6

Relationship Between Body Mass Index (BMI) and time from radiation completion to first incidence of Hemorrhagic Cystitis.

```{r}
#Create a scatter plot
plot6 <- clean_data1 |> 

ggplot(aes(x = radiation_completion_to_first_hc, y = BMI, color = ethnicity)) +
  geom_point() +
  labs(title = "BMI vs Radiation Completion to First HC",
       x = "Radiation Completion to First HC",
       y = "BMI")+
  scale_color_manual(values = c("african_american" = "blue", "caucasian" = "red"))+
  theme_minimal(base_size = 12)
  

#Print plot
print(plot6)

# Save plot to folder called "results"
ggsave(filename = "key_plot_6.png", 
      plot = plot6, 
      path = "~/group_18_project/results",
      width = 8, 
      height = 5, 
      dpi = 300)


```

Plot number 7

Kaplan Meier curve showing the probability of HC-free survival over time (n=562 months).

```{r}
library(survival)

#Create a new data frame to add columns "event" and "time"
event_time <- clean_data2 |> 
  mutate(
    event = as.numeric(hc_incidence == "no"),
    time = rep(1:562, length.out = n())
  )
# Fit a Kaplan-Meier survival curve using the function: survfit
km_fit <- survfit(Surv(time, event) ~ 1, data = clean_data2)

#Create plot
plot7 <- plot(km_fit, main = "Kaplan-Meier Curve of HC-Free Survival P. vs Time",
              xlab = "Time (Months)", ylab = "HC-Free Survival Probability",
              col = "blue", lwd = 2, conf.int = FALSE)

# Add a legend
legend("topright", legend = c("HC-Free Survival"), col = c("blue"), lwd = 2, lty = 1)

#Print plot
print(plot7)


# Save the plot to folder results
ggsave(filename = "~/group_18_project/results/key_plot_7.png", 
       plot = last_plot(), 
       width = 8, 
       height = 5, 
       dpi = 300)

```

bn

Plot 8: The distribution of radiation duration among different types of radiation.

```{r}
# Boxplot
boxplot_plot <- ggplot(analysis_1, aes(x = radiation_type, y = radiation_duration, fill = radiation_type)) +
  geom_boxplot() +
  labs(title = "Boxplot of Radiation Durations",
       x = "Radiation Type",
       y = "Radiation Duration") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate x-axis labels

# Display the boxplot
print(boxplot_plot)

```

nm
